# キャプション・ハイライター 要件定義書 (v0.1)

## 1. 目的
- Google Meet の自動字幕を取得・解析し、あらかじめ登録した辞書に合致する語句をリアルタイムで強調表示する Chrome 拡張機能を提供する。
- 用語の意味をポップアップで提示し、会議参加者の理解を支援する。
- 将来的なサブスクリプション機能に拡張しやすい基盤を整える。

## 2. スコープ
- 対象プラットフォーム: Google Chrome ブラウザ上で動作する拡張機能。
- 対象サービス: Google Meet のライブ字幕。
- 初期リリースで対応する言語: Google Meet が提供する字幕言語（詳細は追加調査）。
- 初期スコープでは課金／ユーザー管理機能は実装しないが、拡張を想定した構造とする。

## 3. 利用者像 & ユースケース
- **一般ユーザー**: Google Meet で専門用語を理解したい個人。
- **チーム利用**: 辞書を共有して用語統一を図るチーム（共有機能は今後の検討）。
- **ユースケース例**:
  - 会議中に専門用語が表示された際、自動的にハイライトされ意味を確認する。
  - 会議前に CSV で辞書をインポートし用語を準備する。

## 4. 用語定義
- **字幕**: Google Meet が提供するライブ文字起こし結果。
- **辞書**: キー（用語）と意味のペアの集合。将来的に属性追加の可能性あり。
- **ハイライト**: 字幕内の該当語句を強調表示する UI 効果。
- **ポップアップ**: ハイライト上にマウスホバーした際に表示する意味説明の UI。

## 5. 機能要件
### 5.1 字幕取得・監視
- Google Meet の字幕 DOM を監視し、表示されたテキストをリアルタイムで取得する。
- 取得した字幕を行単位・発話単位で処理できる構造を持つ。
- 字幕の更新頻度・遅延についてブラウザ API の制限内で最適化する。

### 5.2 辞書管理
- CSV ファイルをインポートして辞書を登録できる。
- CSV 読み込み時、存在する列名を解析し、ユーザーが「キー列」「意味列」を選択できる UI を提供する。
- 解析結果を元に辞書エントリ（キー／意味ペア）を生成する。空行や欠損値は無視する。
- 初期スコープではローカル（`chrome.storage` 等）に保存する。今後クラウド同期に拡張できる構造を想定する。
- 辞書の一覧表示、検索、削除（単一・全体）を行える管理 UI を用意する。

### 5.3 ハイライト処理
- 取得した字幕テキスト内でキーを検索し、一致箇所をハイライトする。
- マッチング条件（大小文字の区別、部分一致／完全一致など）は設定可能にする（初期値の仕様は要確認）。
- 字幕エリアの DOM を侵襲的に改変しないよう配慮し、レンダリング性能を確保する。
- 同一字幕内で複数箇所マッチした場合もすべてハイライトする。
- 同一キーの複数辞書エントリは最初の一致を採用（複数対応は今後検討）。

### 5.4 ポップアップ表示
- ハイライト箇所にマウスホバーした際、意味を表示するポップアップを表示する。
- ポップアップはスクリーン外に出ないよう位置補正を行う。
- ハイライトのフォーカス解除時にポップアップを閉じる。
- ポップアップのスタイル（色、サイズ）は設定可能にする（最低限のテーマ切替）。

### 5.5 設定 UI / オプションページ
- Vue.js + TypeScript で構築する。
- 辞書管理、マッチングルール、ハイライトテーマ等を設定できるオプションページを用意する。
- UI コンポーネントは再利用可能な構造とし、Storybook で確認できるようにする。

### 5.6 バックグラウンド処理
- 拡張のメインロジック（字幕監視とハイライト処理）はコンテンツスクリプトとして実装する。
- CSV の解析や設定情報の保持はバックグラウンド/オプションページと連携する。
- 将来的なサブスク制御に備え、ユーザー状態を判定する API 呼び出しの拡張ポイントを計画しておく。

## 6. 非機能要件
- **技術スタック**: Vue 3, TypeScript, Vite ベースの拡張テンプレート（vitesse-webext を参考）。
- **UI コンポーネント検証**: Storybook を導入し、主要コンポーネントのステートを確認可能にする。ビルド（`yarn storybook` 等）を CI/ローカルで検証する。
- **テスト**: Vue Test Utils 等を用いたコンポーネント単位のユニットテストを C.I. で実行する。辞書処理やマッチングロジックの純粋関数には Node 上のテストを追加。
- **パフォーマンス**: ライブ字幕に対し遅延 200ms 以内でハイライトが反映されることを目標とする。
- **アクセシビリティ**: ハイライトの色コントラストを WCAG AA 等級相当とし、キーボード操作でポップアップを開閉できる仕組みを検討（初期版は hover 中心）。
- **セキュリティ / プライバシー**:
  - 既定（デフォルト）では字幕テキスト・辞書を外部送信しない（ローカル処理で完結）。
  - ただし将来/拡張として、ユーザーが明示的に有効化した場合に限り、ホワイトボード要約のために字幕テキストを外部 LLM へ送信できる（beta 機能、既定OFF、同意必須）。
  - 外部送信を有効化する場合は、送信先/用途/注意事項（課金・レート制限等）をオプション画面で明示し、ユーザー同意を取得する。
  - 将来的に Gemini Nano（ローカルLLM）が一般化した場合は、ローカル完結を優先する方針とする。
- **拡張性**: 将来的な課金ステータス判定・辞書登録数制限を実装しやすい形でデータモデル・設定管理を抽象化する。

## 7. 制約・前提条件
- Chrome Extension Manifest v3 を採用する。
- Google Meet の DOM 構造変更に伴う影響を受ける可能性があるため、セレクタを抽象化し変更に耐えられる設計とする。
- CSV は UTF-8 (BOM 無し) を前提。Excel 等からの出力差異は今後の課題。
- 初期リリースでは単一ユーザーのローカル辞書のみ対応。サインイン機能は今後検討。

## 8. 将来拡張の検討事項
- サブスクリプション連携: 決済プラットフォーム選定、ユーザー認証・権限管理、辞書の上限制御。
- 辞書共有: チーム向け同期機能、クラウドストレージ連携。
- 多言語対応強化: Google Meet 以外の会議ツールへの拡張。
- 辞書エントリのタグ付け、カテゴリ分け、注釈追加。
- ホワイトボード要約:
  - ローカルLLM（Gemini Nano）を優先し、条件が整った場合にローカル完結へ回帰する。
  - 外部LLM（Gemini Flash 等）は beta 扱いとし、同意と設定を前提に提供する。

## 5.7 ホワイトボード要約（字幕の構造化メモ）
- Google Meet の字幕を一定間隔でバッファし、会議メモとして構造化して表示する（ホワイトボード機能）。
- 要約エンジンは以下から選択できる（初期スコープでは2択）:
  - **Gemini Nano（ローカル）**: ブラウザ内蔵 LLM（利用可能な場合のみ）。
  - **Gemini Flash（クラウド / beta）**: 外部APIを利用。既定OFF、同意と設定が必要。
- Gemini Flash（クラウド / beta）の要件:
  - 字幕テキストが外部へ送信されることを明示し、ユーザー同意を取得する（オプション画面）。
  - ユーザーが API Key を設定できる UI を提供する（AI Studio 方式を想定）。
  - 通信失敗・レート制限・課金等の注意事項を UI で案内する。

## 9. 成果物
- 要件定義書 (本ドキュメント)。
- 後続フェーズでアーキテクチャ設計、画面設計、テスト計画を策定予定。

## 10. オープン課題 / 要確認事項
- ハイライト対象の一致ルール（部分一致、正規表現対応等）の詳細。
- CSV カラム選択 UI の操作フロー（複数列選択、プレビューの有無）。
- ポップアップで表示する追加情報（例: 例文、リンク）の必要性。
- Storybook / テストの具体的なコマンドや CI 環境の要件。
- Google Meet DOM 変更時の検知・アップデート方針。
